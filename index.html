<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>math.js | plot</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.1/math.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-1.35.2.min.js"></script>

    <style>
        input[type=text] {
            width: 300px;
        }

        input {
            padding: 6px;
        }

        body,
        html,
        input {
            font-family: sans-serif;
            font-size: 11pt;

        }

        form {
            margin: 20px 0;
        }
    </style>
</head>

<body>

    <form id="form">
        <label for="eq">Enter an equation:</label>
        <input type="text" id="eq" value="4 * sin(x) + 5 * cos(x/2)" />
        <input type="submit" value="Draw" />
    </form>

    <div id="plot"></div>

    <script>
        var kEpsilon = 0.000001;

        function getTangentXIntercept(f, d, x) {
            var y = f.evaluate({ x: x });
            var m = d.evaluate({ x: x });
            if (m === 0.0) {
                if (y === 0.0) {
                    return y;
                } else {
                    return undefined;
                }
            }
            return (m * x - y) / m;
        }

        /**
         * Find a root with |start_x| as the starting X value.
         * Return undefined if no root can be found.
         */
        function findRoot(f, d, start_x, max_iters) {
            var x;
            for (var i = 0; i < max_iters; i++) {
                x = getTangentXIntercept(f, d, start_x);
                if (x === undefined) {
                    return undefined;
                }
                if (x === start_x) {
                    return x;
                }
                start_x = x;
            }

            return Math.abs(f.evaluate({ x: x })) <= kEpsilon ? x : undefined;
        }

        /**
         * Find all roots (zeros) for the given function |f| which evaluates the
         * expression |expr|.
         **/
        function findRoots(f, trace, xmin, xmax) {
            const kMaxIters = 50;
            const kMaxFinds = 200;
            const kMinRootXSpacing = kEpsilon;
            const delta = (xmax - xmin) / kMaxFinds;

            const d = math.derivative(f, 'x');

            var start_x = xmin;
            for (var i = 0; i < kMaxFinds && start_x < xmax; i++) {
                var root = findRoot(f, d, start_x, kMaxIters);
                start_x += delta;
                if (root === undefined || root < xmin || root > xmax) {
                    continue;
                }
                if (!trace.x) {
                    trace.x = [root];
                    trace.y = [f.evaluate({ x: root })];
                } else if (!trace.x.includes(root)) {
                    trace.x.push(root);
                    trace.y.push(f.evaluate({ x: root }));
                }
            }
        }

        /**
         * Find the extrema for the expression |expr| within the interval [xmin, xmax].
         * Populate |trace.x| and |trace.y| with all extrema found in the interval.
         */
        function findExtrema(f, trace, xmin, xmax) {
            console.log(`findExtrema expr ${f.toString()}`);
            const d = math.derivative(f, 'x');
            findRoots(d, trace, xmin, xmax);
            if (trace.x) {
                for (var i = 0; i < trace.x.length; i++) {
                    trace.y[i] = f.evaluate({ x: trace.x[i] });
                }
            }
        }

        function draw() {
            try {
                const xMin = -10.0;
                const xMax = 10.0;
                const delta = (xMax - xMin) / 200;

                const expression = document.getElementById('eq').value;
                const node = math.parse(expression);
                const f = math.compile(expression);

                // Calculate the plot points.
                const xValues = math.range(xMin, xMax, delta).toArray()
                const yValues = xValues.map(function (x) {
                    return f.evaluate({ x: x });
                })

                // Render the plot.
                const funcData = {
                    x: xValues,
                    y: yValues,
                    type: 'scatter',
                    name: 'Function'
                }
                const roots = {
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Roots'
                }
                const extrema = {
                    type: 'scatter',
                    mode: 'markers',
                    name: 'Extrema'
                }
                findRoots(node, roots, xMin, xMax);
                findExtrema(node, extrema, xMin, xMax);
                const data = [funcData, roots, extrema];
                var layout = {
                    xaxis: {
                        autorange: false
                    },
                    yaxis: {
                        autorange: true
                    }
                };
                Plotly.newPlot('plot', data)
            }
            catch (err) {
                console.error(err)
                alert(err)
            }
        }

        document.getElementById('form').onsubmit = function (event) {
            event.preventDefault()
            draw()
        }

        draw()
    </script>

</body>

</html>